Title: <em>Moneyball</em>
Author: Dr. Glasbrenner
Author_Image: https://www.gravatar.com/avatar/49802fdfa5a0e63b3d932a5179d41c1e
Date: 2018-06-19 13:30
Tags: lab
Slug: lab-07-moneyball
Summary: Build predictive models of baseball data, just like in the movie <em>Moneyball</em>
Show_summary: true
Show_link: true

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE, eval = TRUE, fig.width = 6, warning = FALSE,
  message = FALSE, dev = "svg",
  fig.asp = 0.618, out.width = "80%", dpi = 120,
  fig.align = "center", cache = FALSE
)
suppressPackageStartupMessages(library(tidyverse))

icon_pdf <- '<i class="fas fa-file-pdf" data-fa-transform="grow-16"></i>&nbsp;'
icon_github <- '<i class="fab fa-github-alt" data-fa-transform="grow-16"></i>&nbsp;'
```

> This week's lab will show you how to build predictive models using linear regression and data collected on the 2011 Major League Baseball season.

## Data science in sports and at the movies

The movie [Moneyball][moneyball-wiki] focuses on the "quest for the secret of success in baseball".
It follows a low-budget team, the Oakland Athletics, who believed that underused statistics, such as a player's ability to get on base, better predict the ability to score runs than typical statistics like home runs, RBIs (runs batted in), and batting average.
Obtaining players who excelled in these underused statistics turned out to be much more affordable for the team.

## About this week's dataset

This dataset is the data from the 2011 Major League Baseball (MLB) season, containing several different kinds of summary statistics for the different teams.

| Variable                    | Description                                                         |
| --------------              | ------------------------------------------------------              |
| [team]{.monospace}          | Name of baseball team                                               |
| [runs]{.monospace}          | Number of runs scored                                               |
| [at\_bats]{.monospace}      | Number of players at bat                                            |
| [hits]{.monospace}          | Number of hits                                                      |
| [homeruns]{.monospace}      | Number of homeruns                                                  |
| [bat\_avg]{.monospace}      | Team batting average                                                |
| [strikeouts]{.monospace}    | Number of strikeouts                                                |
| [stolen\_bases]{.monospace} | Number of bases stolen                                              |
| [wins]{.monospace}          | Number of games won                                                 |
| [new\_onbase]{.monospace}   | On-base percentage                                                  |
| [new\_slug]{.monospace}     | Slugging percentage (total bases divided by [at\_bats]{.monospace}) |
| [new\_obs]{.monospace}      | On-base plus slugging percentages                                   |

The first seven variables, `at_bats`, `hits`, `homeruns`, `bat_avg`, `strikeouts`, `stolen_bases`, and `wins`, are the [traditionally used variables][traditional-baseball-statistics] for baseball statistics.
The last three variables, `new_onbase`, `new_slug`, and `new_obs`, are the suggested variables that the author of *Moneyball* claims were better predictors of the `runs` variable.

@.  What type of plot would you use to display the relationship between `runs` and one of the other numerical variables?
    Plot this relationship using the variable `at_bats` as the explanatory variable (horizontal axis).
    Does the relationship look linear?
    If you knew a team's `at_bats`, would you be comfortable using a linear model to predict the number of runs?

If the relationship looks linear, we can quantify the strength of the relationship with the correlation coefficient.

```r
mlb11 %>% summarize(cor(runs, at_bats))
```

## Sum of squared residuals

When discussing the distribution of a single variable, we focus on characteristics such as *center*, *spread*, and *shape*, [click here to read a refresher on these concepts][univariate-description].
It's also useful to be able to describe the relationship of two numerical variables, such as `runs` and `at_bats` above.

@.  Looking at your plot from the previous exercise, describe the relationship between these two variables.
    Make sure to discuss the form, direction, and strength of the relationship as well as any unusual observations.

Just as we used the mean and standard deviation to summarize a single variable, we can summarize the relationship between these two variables by finding the line that best follows their association.
**Open your *Console* window and type the following code snippet into it to launch an interactive function.**
Running this function will display a figure in the *Plots* window on the right side of RStudio.
You should be able to click two points on the figure, which R will then use to draw a line.
Try and select two points that will a line that you think does the best job of going through the cloud of points.

```r
plot_ss(x = mlb11$at_bats, y = mlb11$runs)
```

Once you've done that, the line you specified will be shown in black and the residuals in blue.
Note that there are 30 residuals, one for each of the 30 observations.
The **residuals** are the difference between the observed values and the values predicted by the line,
\\[\text{residual for data point at (x, y)}=\text{observed data point at (x, y)}-\text{line's prediction for at (x, y)}\\]
The most common way to do linear regression is to select the line that minimizes the sum of squared residuals.
To visualize the squared residuals, you can rerun the plot command and add the argument `showSquares = TRUE`.

```r
plot_ss(x = mlb11$at_bats, y = mlb11$runs, showSquares = TRUE)
```

Note that the output from the `plot_ss` function provides you with the slope and intercept of your line as well as the sum of squares.

@.  Using `plot_ss`, choose a line that does a good job of minimizing the sum of squares.
    Run the function several times.
    What was the smallest sum of squares that you got?
    How does it compare to your neighbors?

## The linear model

It is rather cumbersome to try to get the correct least squares line, i.e. the line that minimizes the sum of squared residuals, through trial and error.
Instead we can use the `lm` function in R to fit the linear model (a.k.a. regression line).

```r
model1 <- lm(runs ~ at_bats, data = mlb11)
```

The first argument in the function `lm` is a formula that takes the form `y ~ x`.
Here it can be read that we want to make a linear model of `runs` as a function of `at_bats`.
The second argument specifies that R should look in the `mlb11` tibble to find the `runs` and `at_bats` variables.

The output of `lm` is an object that contains all of the information we need about the linear model that was just fit.
We can access this information using the summary function.

```r
summary(model1)
```

Let's consider this output piece by piece.
First, the formula used to describe the model is shown at the top.
After the formula you find the five-number summary of the residuals.
The "Coefficients" table shown next is key; its first column displays the linear model's y-intercept and the coefficient of `at_bats`.
With this table, we can write down the least squares regression line for the linear model:
\\[y(\text{at\_bats})=-2789.2429+0.6305\times\text{at\_bats}\\]
One last piece of information we will discuss from the summary output is the Multiple R-squared, or more simply, $R^2$.
The $R^2$ value represents the proportion of variability in the response variable that is explained by the explanatory variable.
For this model, 37.3% of the variability in runs is explained by `at_bats`.

@.  Fit a new model that uses `homeruns` to predict `runs`.
    Using the estimates from the R output, write the equation of the regression line.
    What does the slope tell us in the context of the relationship between success of a team and its home runs?

:::::{.callout .secondary}
[Writing your least-squares equation in Markdown]{style="font-size: 1.7em; font-weight: bold;"}

Use the following Markdown snippet as a template for writing your regression line equation in exercise 4:

```markdown
$$y(\text{homeruns}) = intercept + slope \times \text{homeruns}$$
```

The entire snippet --- including the double dollar signs \$\$ --- should be copied and then pasted onto a separate line in your RMarkdown file.
This is pasted as part of your Markdown text, so it should *not* be placed in a code block.
Replace the placeholder words `intercept` and `slope` with your numerical values.
:::::


## Prediction and prediction errors

Let's create a scatterplot with the least squares line laid on top.

```r
ggplot(data = mlb11) +
  geom_point(mapping = aes(x = at_bats, y = runs)) +
  geom_smooth(mapping = aes(x = at_bats, y = runs), method = "lm", se = FALSE)
```

The function `geom_smooth()` with the `method="lm"` input plots the linear regression line for us.
This line can be used to predict `runs` at any value of `at_bats`.
When predictions are made for values of `at_bats` that are beyond the range of the observed data, it is referred to as *extrapolation* and is not usually recommended.
However, predictions made within the range of the data are more reliable.
They're also used to compute the residuals.

@.  If a team manager saw the least squares regression line and not the actual data, how many runs would he or she predict for a team with 5,578 `at_bats`?
    Is this an overestimate or an underestimate, and by how much?
    In other words, what is the residual for this prediction?

## Model diagnostics

To assess whether the linear model is reliable, we need to check for (1) linearity, (2) nearly normal residuals, and (3) constant variability.

**Linearity** ---
You already checked if the relationship between `runs` and `at_bats` is linear using a scatterplot.
We should also verify this condition with a plot of the residuals vs. `at_bats`.

```r
ggplot(data = model1) +
  geom_point(mapping = aes(x = at_bats, y = .resid)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Residuals")
```

@.  Is there any apparent pattern in the residuals plot?
    What does this indicate about the linearity of the relationship between `runs` and `at_bats`?

**Nearly normal residuals** ---
To check this condition, we can look at a histogram,

```r
ggplot(data = model1) +
  geom_histogram(mapping = aes(x = .resid), binwidth = 25) +
  labs(x = "Residuals")
```

or a normal probability plot of the residuals.
First, we calculate the slope and intercept of what an ideal normal distribution for the residuals would look like:

```r
qq_x <- qnorm(c(0.25, 0.75))
qq_y <- quantile(model1$residuals, c(0.25, 0.75))
qq_slope <- diff(qq_y) / diff(qq_x)
qq_int <- qq_y[1] - qq_slope * qq_x[1]
```

Then we plot the Q-Q plot and the ideal line for the residuals together:

```r
ggplot(data = model1) +
  geom_qq(mapping = aes(sample = .resid)) +
  geom_abline(intercept = qq_int, slope = qq_slope) +
  labs(y = "observed")
```

@.  Based on the histogram and the normal probability plot, does the nearly normal residuals condition appear to be met?

**Constant variability** ---
To meet this condition, the variability of points around the least squares line needs to remain roughly constant. 
In other words, the spread of the residuals should not change as you alter `at_bats`.

@.  Based on the plot in exercise 6, does the constant variability condition appear to be met?

## Additional questions

:::::{.additional-questions}
*   Choose another traditional variable from `mlb11` that you think might be a good predictor of `runs`.
    Produce a scatterplot of the two variables and fit a linear model.
    At a glance, does there seem to be a linear relationship?

*   How does this relationship compare to the relationship between `runs` and `at_bats`?
    Use the $R^2$ values from the two model summaries to compare.
    Does your variable seem to predict `runs` better than `at_bats`?
    How can you tell?

*   Now that you can summarize the linear relationship between two variables, investigate the relationships between `runs` and each of the other five traditional variables: `hits`, `bat_avg`, `strikeouts`, `stolen_bases`, and `wins`
    Which variable best predicts `runs`?
    Support your conclusion using the graphical and numerical methods we've discussed (for the sake of conciseness, only include output for the best variable, not all five).

*   Now examine the three newer variables: `new_onbase`, `new_slug`, and `new_obs`.
    These are the statistics used by the author of *Moneyball* to predict a teams success.
    In general, are they more or less effective at predicting runs than the old variables?
    Explain using appropriate graphical and numerical evidence.
    Of all ten variables we've analyzed, which seems to be the best predictor of `runs`?
    Using the limited (or not so limited) information you know about these baseball statistics, does your result make sense?

*   Check the model diagnostics for the regression model with the variable you decided was the best predictor for runs.
:::::

## How to submit

When you are ready to submit, be sure to save, commit, and push your final result so that everything is synchronized to Github.
Then, navigate to **your copy** of the Github repository you used for this assignment.
You should see your repository, along with the updated files that you just synchronized to Github.
Confirm that your files are up-to-date, and then do the following steps:

:::::{.pull-request}
*   Click the *Pull Requests* tab near the top of the page.

*   Click the green button that says "New pull request".

*   Click the dropdown menu button labeled "base:", and select the option `starting`.

*   Confirm that the dropdown menu button labeled "compare:" is set to `master`.

*   Click the green button that says "Create pull request".

*   Give the *pull request* the following title: [Submission: Lab 7, FirstName LastName]{.monospace}, replacing [FirstName]{.monospace} and [LastName]{.monospace} with your actual first and last name.

*   In the messagebox, write: [My lab report is ready for grading \@jkglasbrenner]{.monospace}.

*   Click "Create pull request" to lock in your submission.
:::::

## Credits

This lab, *Moneyball*, is a derivative of [OpenIntro Lab 9 – Introduction to linear regression][openintro-lab-9] by Andrew Bray and Mine Çetinkaya-Rundel, which was adapted from a lab written by the faculty and TAs of UCLA Statistics, used under [CC BY-SA 3.0][cc-by-sa-3].
*Moneyball* is licensed under a [Creative Commons Attribution-ShareAlike 4.0 International License][cc-by-sa-4] by James Glasbrenner.

[cc-by-sa-3]:                      https://creativecommons.org/licenses/by-sa/3.0/
[cc-by-sa-4]:                      http://creativecommons.org/licenses/by-sa/4.0/
[moneyball-wiki]:                  http://en.wikipedia.org/wiki/Moneyball_(film)
[openintro-lab-9]:                 https://htmlpreview.github.io/?https://github.com/andrewpbray/oiLabs-base-R/blob/master/simple_regression/simple_regression.html
[univariate-description]:          http://stattrek.com/statistics/charts/data-patterns.aspx
[traditional-baseball-statistics]: https://en.wikipedia.org/wiki/Baseball_statistics#Commonly_used_statistics
